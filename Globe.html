<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WereldExplorer — ontdek de mooiste plekken per land</title>

  <!--
    Externe libs (CDN):
      - globe.gl (ThreeJS globe + polygons + points)
      - d3 (geoCentroid/geoBounds)
      - topojson-client (TopoJSON -> GeoJSON)
    Let op: dit is een single-file demo. Voor productie: pin versies en host assets zelf.
  -->
  <script src="https://cdn.jsdelivr.net/npm/globe.gl@2.45.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>

  <style>
    :root{
      --bg: #06080f;
      --panel: rgba(13, 17, 27, 0.92);
      --panel2: rgba(10, 14, 22, 0.85);
      --text: #e8ecff;
      --muted: rgba(232,236,255,0.68);
      --line: rgba(255,255,255,0.12);
      --accent: #7aa8ff;
      --good: #45e6b0;
      --warn: #ffcc66;
      --bad: #ff6b7a;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: var(--sans); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Layout */
    #app {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #globeWrap {
      position: absolute;
      inset: 0;
    }

    #globeViz {
      width: 100%;
      height: 100%;
    }

    /* Top bar */
    .topbar {
      position: absolute;
      top: 16px;
      left: 16px;
      right: 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      pointer-events: none; /* zodat je globe nog kan slepen */
      z-index: 5;
    }
    .topbar .pill {
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0,0,0,0.28);
      border: 1px solid var(--line);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
    }

    .brand {
      font-weight: 720;
      letter-spacing: .2px;
      display: flex;
      align-items: center;
      gap: 10px;
      user-select: none;
      white-space: nowrap;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
      box-shadow: 0 0 18px rgba(122,168,255,.6);
    }
    .kbd {
      font-family: var(--mono);
      font-size: 12px;
      opacity: .85;
      border: 1px solid var(--line);
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
    }

    /* Side panel */
    #panel {
      position: absolute;
      top: 16px;
      bottom: 16px;
      right: 16px;
      width: min(520px, calc(100% - 32px));
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      z-index: 6;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: translateX(0);
      transition: transform .25s ease;
    }
    #panel.closed { transform: translateX(calc(100% + 22px)); }

    .panelHeader {
      padding: 14px 14px 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(to bottom, rgba(255,255,255,0.06), rgba(255,255,255,0));
    }

    .panelHeader h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: .2px;
    }

    .btnRow { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    button, .btn {
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 620;
      letter-spacing: .15px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select: none;
    }
    button:hover, .btn:hover { background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.18); }
    button:active, .btn:active { transform: translateY(1px); }
    button.primary {
      background: rgba(122,168,255,0.18);
      border-color: rgba(122,168,255,0.35);
    }
    button.primary:hover { background: rgba(122,168,255,0.25); }
    button.danger {
      background: rgba(255,107,122,0.12);
      border-color: rgba(255,107,122,0.25);
    }

    .panelBody {
      padding: 14px;
      overflow: auto;
      flex: 1;
      display: grid;
      gap: 12px;
      align-content: start;
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      padding: 12px;
    }

    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .muted { color: var(--muted); }
    .small { font-size: 12.5px; }
    .tiny { font-size: 12px; }
    .mono { font-family: var(--mono); }

    .searchRow {
      display: grid;
      gap: 10px;
    }
    .searchRow input {
      width: 100%;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 11px 12px;
      border-radius: 12px;
      outline: none;
    }
    .searchRow input:focus { border-color: rgba(122,168,255,0.5); box-shadow: 0 0 0 3px rgba(122,168,255,0.12); }

    .statusLine {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.12);
    }
    .spinner {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.22);
      border-top-color: rgba(122,168,255,0.9);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .placeList {
      display: grid;
      gap: 10px;
    }
    .place {
      display: grid;
      grid-template-columns: 88px 1fr;
      gap: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      cursor: pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .place:hover { background: rgba(255,255,255,0.07); border-color: rgba(255,255,255,0.18); }
    .place:active { transform: translateY(1px); }

    .thumb {
      width: 88px;
      height: 66px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: linear-gradient(135deg, rgba(122,168,255,0.18), rgba(255,255,255,0.05));
      display: grid;
      place-items: center;
      color: rgba(255,255,255,0.7);
      font-size: 12px;
      text-align: center;
      padding: 6px;
    }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .place h4 { margin: 0; font-size: 14px; line-height: 1.25; }
    .place p { margin: 4px 0 0 0; font-size: 12.5px; color: var(--muted); line-height: 1.35; }
    .coords {
      margin-top: 6px;
      font-size: 12px;
      color: rgba(232,236,255,0.8);
      font-family: var(--mono);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.12);
      color: rgba(232,236,255,0.75);
    }

    /* Floating help */
    #help {
      position: absolute;
      bottom: 16px;
      left: 16px;
      z-index: 5;
      pointer-events: none;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      max-width: min(720px, calc(100% - 32px));
    }
    #help .hint {
      pointer-events: auto;
      background: rgba(0,0,0,0.28);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
      display: flex;
      align-items: center;
      gap: 10px;
      color: rgba(232,236,255,0.88);
      font-size: 13px;
    }
    .hint strong { color: var(--text); }
    .hint .miniDot { width: 8px; height: 8px; border-radius: 50%; background: var(--good); box-shadow: 0 0 14px rgba(69,230,176,.45); }

    /* Small screens */
    @media (max-width: 760px){
      #panel {
        left: 16px;
        right: 16px;
        width: auto;
      }
      #panel.closed { transform: translateY(calc(100% + 22px)); }
      #panel { top: auto; height: 72vh; bottom: 16px; }
    }

    /* Globe marker HTML */
    .pin {
      width: 14px;
      height: 14px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      background: rgba(122,168,255,0.95);
      border: 1px solid rgba(255,255,255,0.35);
      box-shadow: 0 0 16px rgba(122,168,255,.55);
      position: relative;
      cursor: pointer;
    }
    .pin::after{
      content: "";
      width: 6px; height: 6px;
      border-radius: 50%;
      background: rgba(255,255,255,0.85);
      position: absolute;
      top: 3.5px; left: 3.5px;
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="globeWrap">
      <div id="globeViz"></div>
    </div>

    <!-- Topbar -->
    <div class="topbar">
      <div class="pill brand">
        <span class="dot"></span>
        <span>WereldExplorer</span>
        <span class="kbd">klik land</span>
      </div>

      <div class="pill" style="margin-left:auto;">
        <button id="togglePanelBtn" class="primary" title="Paneel tonen/verbergen (P)">Paneel</button>
        <button id="randomBtn" title="Ga naar een willekeurig land (R)">Random</button>
        <button id="resetBtn" title="Terug naar wereldbeeld (0)">Reset</button>
      </div>
    </div>

    <!-- Side panel -->
    <aside id="panel">
      <div class="panelHeader">
        <div style="display:grid;gap:2px;">
          <h2 id="panelTitle">Klik op een land</h2>
          <div class="muted tiny" id="panelSubtitle">Dan laad ik automatisch 5+ mooie plekken met coördinaten.</div>
        </div>
        <div class="btnRow">
          <button id="clearPinsBtn" class="danger" title="Verwijder pins">Pins weg</button>
          <button id="copyLinkBtn" title="Kopieer deeplink naar dit land">Link</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="card searchRow">
          <div class="row">
            <div>
              <div class="small" style="font-weight:700;">Zoek een land</div>
              <div class="muted tiny">Typ een naam en druk Enter.</div>
            </div>
            <div class="tag">Data: Natural Earth + Wikidata</div>
          </div>

          <input id="countrySearch" list="countryList" placeholder="Bijv. Nederland, Japan, Peru…" />
          <datalist id="countryList"></datalist>

          <div class="row">
            <button id="tourBtn" class="primary" title="Speel: elke 6 seconden een nieuw land (kan WDQS belasten)">Tour-modus</button>
            <button id="stopTourBtn" title="Stop tour">Stop</button>
            <span class="muted tiny" id="tourStatus" style="margin-left:auto;">Tour: uit</span>
          </div>
        </div>

        <div class="card" id="countryMetaCard" style="display:none;">
          <div class="row">
            <div>
              <div class="small" style="font-weight:750;">Landinfo</div>
              <div class="muted tiny">Afkomstig uit Wikidata.</div>
            </div>
            <a id="countryWikidataLink" class="tiny" target="_blank" rel="noopener">Wikidata ↗</a>
          </div>
          <div style="display:grid;gap:8px;margin-top:10px;">
            <div class="row">
              <div class="muted tiny">ISO-numeric</div>
              <div class="mono tiny" id="isoNumeric">—</div>
            </div>
            <div class="row">
              <div class="muted tiny">Hoofdstad</div>
              <div class="tiny" id="capital">—</div>
            </div>
            <div class="row">
              <div class="muted tiny">Continent</div>
              <div class="tiny" id="continent">—</div>
            </div>
            <div class="row">
              <div class="muted tiny">Bevolking</div>
              <div class="tiny" id="population">—</div>
            </div>
          </div>
        </div>

        <div class="card" id="statusCard">
          <div class="statusLine" id="statusLine">
            <div class="miniDot" style="width:10px;height:10px;border-radius:50%;background:var(--warn);box-shadow:0 0 14px rgba(255,204,102,.35);"></div>
            <div class="small" id="statusText">Tip: sleep om te draaien, scroll om te zoomen.</div>
          </div>
        </div>

        <div class="card" id="placesCard" style="display:none;">
          <div class="row">
            <div>
              <div class="small" style="font-weight:750;">Mooiste plekken</div>
              <div class="muted tiny">Klik op een plek om er naartoe te vliegen.</div>
            </div>
            <div class="tag" id="placesCount">0</div>
          </div>

          <div class="placeList" id="placeList" style="margin-top:10px;"></div>

          <div class="muted tiny" style="margin-top:10px;line-height:1.4;">
            <strong>Opmerking:</strong> “mooiste” is subjectief. Dit haalt populaire natuur- & cultuurplekken uit Wikidata
            (gesorteerd o.a. op bekendheid via sitelinks). Voor sommige landen kan Wikidata minder compleet zijn.
          </div>
        </div>

        <div class="card">
          <div class="small" style="font-weight:750;">Sneltoetsen</div>
          <div class="muted tiny" style="margin-top:6px;line-height:1.5;">
            <span class="kbd">P</span> paneel •
            <span class="kbd">R</span> random •
            <span class="kbd">0</span> reset •
            <span class="kbd">Esc</span> stop tour
          </div>
        </div>
      </div>
    </aside>

    <div id="help">
      <div class="hint">
        <span class="miniDot"></span>
        <div><strong>Klik op een land</strong> → je krijgt 5+ plekken met exacte coördinaten + pins.</div>
      </div>
      <div class="hint">
        <div class="kbd">Shift</div>
        <div>ingedrukt houden = sneller draaien/zoomen.</div>
      </div>
    </div>
  </div>

  <script>
    /**********************************************************************
     * WereldExplorer — single-file demo
     * - Landen: Natural Earth via world-atlas (TopoJSON)
     * - Klik land: haal Wikidata country QID via ISO 3166-1 numeric (P299)
     * - Haal minimaal 5 mooie plekken met coördinaten (P625) + optioneel afbeelding (P18)
     * - Plot pins + lijst met "exacte locatie"
     *
     * PATCHES (stabiliteit + snelheid):
     * 1) WDQS 400/traag: gebruik POST (geen te lange URL), retries + langere timeout.
     * 2) “signal is aborted without reason”: 1 actieve load tegelijk; nieuwe klik annuleert vorige requests netjes.
     * 3) Sneller laden: land-QID + meta in 1 query i.p.v. 2.
     * 4) Snellere places: eerst snelle P17-only query; pas daarna zwaardere P131* fallback.
     **********************************************************************/

    // ====== Config ======
    const WORLD_ATLAS_TOPOJSON = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";

    // Globe textures (hosted via unpkg in three-globe examples)
    const EARTH_IMG = "https://unpkg.com/three-globe/example/img/earth-night.jpg";
    const BUMP_IMG  = "https://unpkg.com/three-globe/example/img/earth-topology.png";
    const SKY_IMG   = "https://unpkg.com/three-globe/example/img/night-sky.png";

    // Wikidata Query Service endpoint
    const WDQS = "https://query.wikidata.org/sparql";

    // Kortere, robuuste typeset (minder query-lengte, minder kans op errors)
    const PRIMARY_PLACE_TYPES = [
      "Q9259",   // UNESCO World Heritage Site
      "Q46169",  // national park
      "Q570116", // tourist attraction
      "Q473972", // protected area
      "Q8502",   // mountain
      "Q34038",  // waterfall
      "Q40080"   // beach
    ];

    // UI refs
    const el = (id) => document.getElementById(id);
    const panel = el("panel");
    const panelTitle = el("panelTitle");
    const panelSubtitle = el("panelSubtitle");
    const statusText = el("statusText");
    const statusLine = el("statusLine");
    const placesCard = el("placesCard");
    const placesCount = el("placesCount");
    const placeList = el("placeList");
    const countrySearch = el("countrySearch");
    const countryList = el("countryList");

    const metaCard = el("countryMetaCard");
    const countryWikidataLink = el("countryWikidataLink");
    const isoNumericEl = el("isoNumeric");
    const capitalEl = el("capital");
    const continentEl = el("continent");
    const populationEl = el("population");

    // Buttons
    const togglePanelBtn = el("togglePanelBtn");
    const randomBtn = el("randomBtn");
    const resetBtn = el("resetBtn");
    const clearPinsBtn = el("clearPinsBtn");
    const copyLinkBtn = el("copyLinkBtn");
    const tourBtn = el("tourBtn");
    const stopTourBtn = el("stopTourBtn");
    const tourStatus = el("tourStatus");

    // ====== State ======
    let globe;                      // Globe instance
    let countriesFC = null;         // GeoJSON FeatureCollection
    let selectedCountry = null;     // GeoJSON Feature
    let hoveredCountry = null;      // GeoJSON Feature
    let currentPins = [];           // array of place objects
    let tourTimer = null;

    // (PATCH) Eén actieve load tegelijk: nieuwe klik annuleert vorige requests netjes.
    // Dit voorkomt “signal is aborted without reason” spam en voorkomt dubbel werk.
    let activeLoadController = null;
    let activeLoadToken = 0;

    // Caches (in-memory)
    const cache = {
      // isoNumeric (3-digit string) -> { countryQid, meta, places, ts }
      byIso: new Map()
    };

    // ====== Helpers ======
    function padIso3(n) {
      const s = String(n ?? "").trim();
      if (!s) return "";
      const digits = s.replace(/[^\d]/g, "");
      if (!digits) return "";
      return digits.padStart(3, "0");
    }

    function fmtNum(x) {
      if (x == null || x === "") return "—";
      const n = Number(x);
      if (!Number.isFinite(n)) return String(x);
      return new Intl.NumberFormat("nl-NL").format(n);
    }

    function setStatus(kind, text) {
      statusText.textContent = text;
      const dot = statusLine.querySelector(".miniDot") || statusLine.firstElementChild;
      if (!dot) return;

      if (kind === "loading") {
        dot.style.background = "var(--accent)";
        dot.style.boxShadow = "0 0 14px rgba(122,168,255,.35)";
      } else if (kind === "ok") {
        dot.style.background = "var(--good)";
        dot.style.boxShadow = "0 0 14px rgba(69,230,176,.35)";
      } else if (kind === "warn") {
        dot.style.background = "var(--warn)";
        dot.style.boxShadow = "0 0 14px rgba(255,204,102,.35)";
      } else {
        dot.style.background = "var(--bad)";
        dot.style.boxShadow = "0 0 14px rgba(255,107,122,.30)";
      }
    }

    function showLoading(text) {
      setStatus("loading", text);
      if (!statusLine.querySelector(".spinner")) {
        const sp = document.createElement("div");
        sp.className = "spinner";
        statusLine.insertBefore(sp, statusLine.children[1] || null);
      }
    }
    function hideLoading(okText) {
      const sp = statusLine.querySelector(".spinner");
      if (sp) sp.remove();
      setStatus("ok", okText);
    }

    function parseWktPoint(wkt) {
      if (!wkt) return null;
      const m = /Point\(([-\d.]+)\s+([-\d.]+)\)/.exec(wkt);
      if (!m) return null;
      const lon = Number(m[1]);
      const lat = Number(m[2]);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      return { lat, lon };
    }

    function qidFromUri(uri) {
      if (!uri) return "";
      const m = /\/(Q\d+)$/.exec(uri);
      return m ? m[1] : "";
    }

    function commonsImageUrl(fileUriOrName, width=520) {
      if (!fileUriOrName) return "";
      const u = String(fileUriOrName);
      if (u.includes("Special:FilePath/")) return u + `?width=${encodeURIComponent(width)}`;
      return `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(u)}?width=${encodeURIComponent(width)}`;
    }

    function googleMapsLink(lat, lon) {
      const q = `${lat},${lon}`;
      return `https://www.google.com/maps?q=${encodeURIComponent(q)}`;
    }

    function setHash(iso3) {
      const url = new URL(location.href);
      url.hash = iso3 ? `#iso=${encodeURIComponent(iso3)}` : "";
      history.replaceState(null, "", url);
    }

    function getHashIso() {
      const h = (location.hash || "").replace(/^#/, "");
      const params = new URLSearchParams(h);
      return params.get("iso") || "";
    }

    function closePanelIfMobile() {
      if (window.matchMedia("(max-width: 760px)").matches) {
        panel.classList.add("closed");
      }
    }

    // ====== WDQS Fetch ======
    // (PATCH) POST i.p.v. GET (voorkomt 400 door te lange URL) + retries + langere timeout.
    // Extra: we ondersteunen een extern signal zodat we requests kunnen cancelen bij een nieuwe klik.
    async function wdqsQuery(sparql, { signal, timeoutMs = 60000 } = {}) {
      const maxTries = 3;

      for (let attempt = 0; attempt < maxTries; attempt++) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), timeoutMs);

        const abortHandler = () => ctrl.abort();
        if (signal) signal.addEventListener("abort", abortHandler, { once: true });

        try {
          const body = new URLSearchParams({ query: sparql });

          const res = await fetch(WDQS, {
            method: "POST",
            headers: {
              "Accept": "application/sparql-results+json",
              "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
            },
            body,
            signal: ctrl.signal
          });

          if (res.ok) return await res.json();

          const retryable = [429, 500, 502, 503, 504].includes(res.status);
          const text = await res.text().catch(() => "");

          if (retryable && attempt < maxTries - 1) {
            await new Promise(r => setTimeout(r, 800 * (attempt + 1)));
            continue;
          }

          throw new Error(`WDQS fout: ${res.status} ${res.statusText} ${text.slice(0, 200)}`);
        } catch (e) {
          // AbortError kan zijn: user-cancel (nieuwe landklik) OF timeout. User-cancel is geen “fout” in UI.
          if (e && (e.name === "AbortError" || String(e).includes("aborted"))) {
            if (signal?.aborted) throw e; // user-cancel → laat caller stilletjes stoppen
            if (attempt < maxTries - 1) continue; // timeout → retry
            throw new Error("Timeout bij Wikidata (WDQS). Probeer opnieuw.");
          }
          throw e;
        } finally {
          clearTimeout(t);
          if (signal) signal.removeEventListener("abort", abortHandler);
        }
      }

      throw new Error("WDQS fout: onbekend");
    }

    // (PATCH) 1 request: countryQid + meta (sneller dan 2 losse queries)
    async function getCountryByIsoWithMeta(iso3, signal) {
      const sparql = `
        SELECT ?country ?capitalLabel ?continentLabel ?population ?flag WHERE {
          ?country wdt:P299 "${iso3}" .
          OPTIONAL { ?country wdt:P36 ?capital . }
          OPTIONAL { ?country wdt:P30 ?continent . }
          OPTIONAL { ?country wdt:P1082 ?population . }
          OPTIONAL { ?country wdt:P41 ?flag . }
          SERVICE wikibase:label { bd:serviceParam wikibase:language "nl,en". }
        }
        LIMIT 1
      `;
      const data = await wdqsQuery(sparql, { signal });
      const b = (data?.results?.bindings || [])[0] || {};

      const uri = b.country?.value || "";
      const countryQid = qidFromUri(uri);

      return {
        countryQid,
        meta: {
          capital: b.capitalLabel?.value || "—",
          continent: b.continentLabel?.value || "—",
          population: b.population?.value || "",
          flag: b.flag?.value || ""
        }
      };
    }

    // (PATCH) Sneller places ophalen:
    // - Eerst: P17-only (direct in country) = snel.
    // - Pas als er te weinig is: zwaardere P131* (admin chain) = traag, maar completer.
    async function queryPlaces(countryQid, { types = [], limit = 80, minSitelinks = 0, includeP131 = false } = {}, signal) {
      const typeBlock = (types && types.length)
        ? `
          VALUES ?t { ${types.map(q => `wd:${q}`).join(" ")} }
          ?place wdt:P31/wdt:P279* ?t .
        `
        : "";

      const sitelinkFilter = minSitelinks > 0
        ? `FILTER(COALESCE(?sitelinks, 0) >= ${Number(minSitelinks)})`
        : "";

      const locationBlock = includeP131
        ? `
          { ?place wdt:P17 ?country . }
          UNION
          { ?place wdt:P131* ?country . }
        `
        : `
          ?place wdt:P17 ?country .
        `;

      const sparql = `
        SELECT ?place ?placeLabel ?placeDescription ?coord ?image ?sitelinks WHERE {
          BIND(wd:${countryQid} AS ?country)
          ?place wdt:P625 ?coord .
          ${locationBlock}
          ${typeBlock}

          FILTER NOT EXISTS { ?place wdt:P31 wd:Q4167836 }   # disambiguation
          FILTER NOT EXISTS { ?place wdt:P31 wd:Q13406463 }  # list article

          OPTIONAL { ?place wdt:P18 ?image . }
          OPTIONAL { ?place wikibase:sitelinks ?sitelinks . }

          ${sitelinkFilter}
          SERVICE wikibase:label { bd:serviceParam wikibase:language "nl,en". }
        }
        ORDER BY DESC(COALESCE(?sitelinks, 0))
        LIMIT ${Number(limit)}
      `;

      const data = await wdqsQuery(sparql, { signal, timeoutMs: 60000 });
      const rows = data?.results?.bindings || [];

      const seen = new Set();
      const places = [];

      for (const r of rows) {
        const placeUri = r.place?.value || "";
        const qid = qidFromUri(placeUri);
        if (!qid || seen.has(qid)) continue;

        const p = parseWktPoint(r.coord?.value);
        if (!p) continue;

        seen.add(qid);

        places.push({
          qid,
          label: r.placeLabel?.value || qid,
          desc: r.placeDescription?.value || "",
          lat: p.lat,
          lng: p.lon,
          image: r.image?.value ? commonsImageUrl(r.image.value, 560) : "",
          sitelinks: r.sitelinks?.value ? Number(r.sitelinks.value) : 0,
          wikidataUrl: placeUri
        });
      }

      return places;
    }

    async function getTopPlaces(countryQid, min = 5, signal) {
      // 1) Snel: P17 + mooie types + beetje “bekend”
      let places = await queryPlaces(countryQid, {
        types: PRIMARY_PLACE_TYPES,
        limit: 80,
        minSitelinks: 2,
        includeP131: false
      }, signal);

      // 2) Nog te weinig? P17 zonder types, maar wel “bekend”
      if (places.length < min) {
        const more = await queryPlaces(countryQid, {
          types: [],
          limit: 100,
          minSitelinks: 10,
          includeP131: false
        }, signal);

        const seen = new Set(places.map(p => p.qid));
        for (const m of more) if (!seen.has(m.qid)) places.push(m), seen.add(m.qid);
      }

      // 3) Nog steeds te weinig? DAN pas de zware P131* fallback
      if (places.length < min) {
        const heavy = await queryPlaces(countryQid, {
          types: PRIMARY_PLACE_TYPES,
          limit: 120,
          minSitelinks: 0,
          includeP131: true
        }, signal);

        const seen = new Set(places.map(p => p.qid));
        for (const m of heavy) if (!seen.has(m.qid)) places.push(m), seen.add(m.qid);
      }

      return places.slice(0, Math.max(min, 5));
    }

    // ====== UI rendering ======
    function renderPlaces(places) {
      placeList.innerHTML = "";
      placesCount.textContent = String(places.length);
      placesCard.style.display = places.length ? "block" : "none";

      for (const p of places) {
        const div = document.createElement("div");
        div.className = "place";

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        if (p.image) {
          const img = document.createElement("img");
          img.src = p.image;
          img.alt = p.label;
          img.loading = "lazy";
          thumb.appendChild(img);
        } else {
          thumb.textContent = "Geen afbeelding\n(in Wikidata)";
        }

        const right = document.createElement("div");

        const h = document.createElement("h4");
        h.textContent = p.label;

        const d = document.createElement("p");
        d.textContent = p.desc || "—";

        const coords = document.createElement("div");
        coords.className = "coords";
        const lat = p.lat.toFixed(5);
        const lng = p.lng.toFixed(5);

        const coordSpan = document.createElement("span");
        coordSpan.textContent = `lat ${lat} · lng ${lng}`;
        coords.appendChild(coordSpan);

        const maps = document.createElement("a");
        maps.href = googleMapsLink(lat, lng);
        maps.target = "_blank";
        maps.rel = "noopener";
        maps.textContent = "Google Maps ↗";
        maps.className = "tag";
        coords.appendChild(maps);

        const wd = document.createElement("a");
        wd.href = p.wikidataUrl;
        wd.target = "_blank";
        wd.rel = "noopener";
        wd.textContent = "Wikidata ↗";
        wd.className = "tag";
        coords.appendChild(wd);

        right.appendChild(h);
        right.appendChild(d);
        right.appendChild(coords);

        div.appendChild(thumb);
        div.appendChild(right);

        div.addEventListener("click", () => {
          flyTo(p.lat, p.lng, 1.2);
        });

        placeList.appendChild(div);
      }
    }

    function renderMeta(iso3, countryQid, meta) {
      metaCard.style.display = "block";
      isoNumericEl.textContent = iso3 || "—";
      capitalEl.textContent = meta?.capital || "—";
      continentEl.textContent = meta?.continent || "—";
      populationEl.textContent = meta?.population ? fmtNum(meta.population) : "—";

      countryWikidataLink.href = `https://www.wikidata.org/wiki/${countryQid}`;
      countryWikidataLink.textContent = "Wikidata ↗";
    }

    function clearPins() {
      currentPins = [];
      globe.pointsData([]);
      globe.htmlElementsData([]);
      placesCard.style.display = "none";
      placesCount.textContent = "0";
      placeList.innerHTML = "";
      setStatus("warn", "Pins verwijderd. Klik opnieuw op een land.");
    }

    // ====== Globe controls ======
    function flyTo(lat, lng, altitude=1.6, ms=900) {
      globe.pointOfView({ lat, lng, altitude }, ms);
    }

    function computeCountryCentroid(feature) {
      try {
        const c = d3.geoCentroid(feature);
        return { lng: c[0], lat: c[1] };
      } catch {
        return { lat: 0, lng: 0 };
      }
    }

    function setSelectedCountry(feature) {
      selectedCountry = feature;

      globe
        .polygonAltitude(d => d === selectedCountry ? 0.08 : (d === hoveredCountry ? 0.04 : 0.01))
        .polygonCapColor(d => d === selectedCountry ? "rgba(122,168,255,0.65)" : (d === hoveredCountry ? "rgba(255,255,255,0.20)" : "rgba(255,255,255,0.08)"))
        .polygonSideColor(() => "rgba(0,0,0,0.20)")
        .polygonStrokeColor(d => d === selectedCountry ? "rgba(255,255,255,0.75)" : "rgba(255,255,255,0.25)");

      const name = feature?.properties?.name || "Onbekend land";
      panelTitle.textContent = name;
      panelSubtitle.textContent = "Even wachten… ik haal 5+ plekken met exacte coördinaten.";
    }

    // (PATCH) Annuleer vorige load; ignore AbortError; sneller pad voor WDQS
    async function onCountryClick(feature) {
      if (!feature) return;

      const iso3 = padIso3(feature.id);
      if (!iso3) {
        setStatus("bad", "Dit object heeft geen ISO-numeric code. Probeer een ander land.");
        return;
      }

      // Cancel vorige load netjes
      if (activeLoadController) activeLoadController.abort();
      activeLoadController = new AbortController();
      const mySignal = activeLoadController.signal;
      const myToken = ++activeLoadToken;

      setHash(iso3);
      setSelectedCountry(feature);

      const c = computeCountryCentroid(feature);
      flyTo(c.lat, c.lng, 1.8, 900);

      showLoading(`Laden… plekken in ${feature.properties.name}`);

      try {
        const cached = cache.byIso.get(iso3);
        if (cached?.places?.length) {
          hideLoading("Gecachet resultaat geladen.");
          panelSubtitle.textContent = "Resultaat uit cache (sneller).";
          renderMeta(iso3, cached.countryQid, cached.meta);
          renderPlaces(cached.places);
          plotPins(cached.places);
          closePanelIfMobile();
          return;
        }

        // 1 request: country + meta
        const { countryQid, meta } = await getCountryByIsoWithMeta(iso3, mySignal);
        if (!countryQid) throw new Error(`Geen Wikidata land gevonden voor ISO-numeric ${iso3}.`);

        if (myToken !== activeLoadToken) return; // user klikte al verder

        // Places in stappen (snel → zwaar)
        const places = await getTopPlaces(countryQid, 5, mySignal);

        if (myToken !== activeLoadToken) return;

        cache.byIso.set(iso3, { countryQid, meta, places, ts: Date.now() });

        hideLoading("Klaar! Klik op een plek om er naartoe te vliegen.");
        panelSubtitle.textContent = "Kies een plek of zoom rond op de pins.";
        renderMeta(iso3, countryQid, meta);
        renderPlaces(places);
        plotPins(places);
        closePanelIfMobile();
      } catch (err) {
        // Abort door doorklikken is geen fout (voorkomt “aborted without reason” in UI)
        if (err && (err.name === "AbortError" || String(err).includes("aborted"))) return;

        const msg = (err && err.message) ? err.message : String(err);
        setStatus("bad", msg);
        panelSubtitle.textContent = "Er ging iets mis bij het ophalen van data (WDQS kan soms traag zijn).";
        console.error(err);
      }
    }

    function plotPins(places) {
      currentPins = places;

      globe
        .pointsData(places)
        .pointLat(d => d.lat)
        .pointLng(d => d.lng)
        .pointAltitude(() => 0.06)
        .pointRadius(() => 0.18)
        .pointLabel(d => `
          <div style="font-family:system-ui;max-width:260px;">
            <div style="font-weight:700;margin-bottom:4px;">${escapeHtml(d.label)}</div>
            <div style="opacity:.85;font-size:12px;line-height:1.35;">${escapeHtml(d.desc || "")}</div>
            <div style="margin-top:6px;font-family:ui-monospace;font-size:12px;opacity:.9;">
              ${d.lat.toFixed(5)}, ${d.lng.toFixed(5)}
            </div>
          </div>
        `);

      globe
        .htmlElementsData(places)
        .htmlLat(d => d.lat)
        .htmlLng(d => d.lng)
        .htmlElement(d => {
          const pin = document.createElement("div");
          pin.className = "pin";
          pin.title = d.label;
          pin.addEventListener("click", (e) => {
            e.stopPropagation();
            flyTo(d.lat, d.lng, 1.15, 700);
          });
          return pin;
        });
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ====== Init ======
    async function init() {
      globe = Globe()(el("globeViz"))
        .globeImageUrl(EARTH_IMG)
        .bumpImageUrl(BUMP_IMG)
        .backgroundImageUrl(SKY_IMG)
        .atmosphereColor("rgba(122,168,255,0.35)")
        .atmosphereAltitude(0.22)
        .showGraticules(false)
        .onPolygonClick(onCountryClick)
        .onPolygonHover(d => {
          hoveredCountry = d || null;
          globe
            .polygonAltitude(x => x === selectedCountry ? 0.08 : (x === hoveredCountry ? 0.04 : 0.01))
            .polygonCapColor(x => x === selectedCountry ? "rgba(122,168,255,0.65)" : (x === hoveredCountry ? "rgba(255,255,255,0.20)" : "rgba(255,255,255,0.08)"))
            .polygonStrokeColor(x => x === selectedCountry ? "rgba(255,255,255,0.75)" : (x === hoveredCountry ? "rgba(255,255,255,0.55)" : "rgba(255,255,255,0.25)"));
        });

      globe.pointOfView({ lat: 18, lng: 10, altitude: 2.35 }, 0);

      showLoading("Wereldkaart laden…");

      const world = await (await fetch(WORLD_ATLAS_TOPOJSON)).json();
      const countries = topojson.feature(world, world.objects.countries);
      countriesFC = countries;

      fillCountryList(countries.features);

      globe
        .polygonsData(countries.features)
        .polygonLabel(d => `
          <div style="font-family:system-ui;">
            <div style="font-weight:700;">${escapeHtml(d.properties.name)}</div>
            <div style="opacity:.85;font-size:12px;">Klik om plekken te laden</div>
          </div>
        `)
        .polygonAltitude(() => 0.01)
        .polygonCapColor(() => "rgba(255,255,255,0.08)")
        .polygonSideColor(() => "rgba(0,0,0,0.20)")
        .polygonStrokeColor(() => "rgba(255,255,255,0.25)");

      hideLoading("Klaar. Klik op een land om te beginnen!");
      panelSubtitle.textContent = "Klik op een land op de globe of zoek in het veld hierboven.";

      const isoFromHash = getHashIso();
      if (isoFromHash) {
        const f = countries.features.find(x => padIso3(x.id) === padIso3(isoFromHash));
        if (f) await onCountryClick(f);
      }
    }

    function fillCountryList(features) {
      countryList.innerHTML = "";
      const opts = [];

      for (const f of features) {
        const name = f?.properties?.name;
        const iso3 = padIso3(f?.id);
        if (!name || !iso3) continue;
        opts.push({ name, iso3 });
      }

      opts.sort((a,b) => a.name.localeCompare(b.name, "nl"));

      for (const o of opts) {
        const opt = document.createElement("option");
        opt.value = o.name;
        opt.label = `${o.name} — ${o.iso3}`;
        countryList.appendChild(opt);
      }
    }

    function findCountryByName(name) {
      if (!countriesFC?.features?.length) return null;
      const q = String(name || "").trim().toLowerCase();
      if (!q) return null;

      let f = countriesFC.features.find(x => String(x.properties?.name || "").toLowerCase() === q);
      if (f) return f;

      f = countriesFC.features.find(x => String(x.properties?.name || "").toLowerCase().startsWith(q));
      if (f) return f;

      f = countriesFC.features.find(x => String(x.properties?.name || "").toLowerCase().includes(q));
      return f || null;
    }

    // ====== Controls / events ======
    togglePanelBtn.addEventListener("click", () => {
      panel.classList.toggle("closed");
    });

    randomBtn.addEventListener("click", () => {
      if (!countriesFC?.features?.length) return;
      const list = countriesFC.features.filter(f => padIso3(f.id));
      const pick = list[Math.floor(Math.random() * list.length)];
      onCountryClick(pick);
    });

    resetBtn.addEventListener("click", () => {
      setHash("");
      selectedCountry = null;
      hoveredCountry = null;
      globe
        .polygonAltitude(() => 0.01)
        .polygonCapColor(() => "rgba(255,255,255,0.08)")
        .polygonStrokeColor(() => "rgba(255,255,255,0.25)");
      flyTo(18, 10, 2.35, 900);
      clearPins();
      metaCard.style.display = "none";
      panelTitle.textContent = "Klik op een land";
      panelSubtitle.textContent = "Dan laad ik automatisch 5+ mooie plekken met coördinaten.";
      setStatus("ok", "Terug naar wereldbeeld.");
    });

    clearPinsBtn.addEventListener("click", () => {
      clearPins();
    });

    copyLinkBtn.addEventListener("click", async () => {
      const iso = selectedCountry ? padIso3(selectedCountry.id) : "";
      const url = new URL(location.href);
      url.hash = iso ? `#iso=${encodeURIComponent(iso)}` : "";
      try {
        await navigator.clipboard.writeText(url.toString());
        setStatus("ok", "Link gekopieerd naar klembord.");
      } catch {
        setStatus("warn", "Kon niet kopiëren (browser). Kopieer handmatig uit de adresbalk.");
      }
    });

    countrySearch.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const f = findCountryByName(countrySearch.value);
      if (f) onCountryClick(f);
      else setStatus("warn", "Land niet gevonden. Probeer een andere spelling.");
    });

    // Tour mode: elke 6 sec random land (handig om te “ontdekken”, maar kan WDQS belasten)
    tourBtn.addEventListener("click", () => {
      if (tourTimer) return;
      tourStatus.textContent = "Tour: aan";
      tourTimer = setInterval(() => {
        if (!countriesFC?.features?.length) return;
        const list = countriesFC.features.filter(f => padIso3(f.id));
        const pick = list[Math.floor(Math.random() * list.length)];
        onCountryClick(pick);
      }, 6000);
      setStatus("ok", "Tour gestart. Druk Esc om te stoppen.");
    });

    function stopTour() {
      if (tourTimer) {
        clearInterval(tourTimer);
        tourTimer = null;
      }
      tourStatus.textContent = "Tour: uit";
      setStatus("ok", "Tour gestopt.");
    }

    stopTourBtn.addEventListener("click", stopTour);

    // Keyboard shortcuts
    window.addEventListener("keydown", (e) => {
      if (e.key === "p" || e.key === "P") panel.classList.toggle("closed");
      if (e.key === "r" || e.key === "R") randomBtn.click();
      if (e.key === "0") resetBtn.click();
      if (e.key === "Escape") stopTour();
    });

    // Start
    init().catch(err => {
      console.error(err);
      setStatus("bad", "Fout bij init. Check console + netwerk (CORS).");
    });
  </script>
</body>
</html>
