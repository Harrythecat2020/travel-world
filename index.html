<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive Travel Globe</title>
  <style>
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:#0f1724;color:#e6eef8}
    #app{display:flex;height:100vh;gap:12px}
    #globe-container{flex:1;position:relative}
    #sidebar{width:380px;background:linear-gradient(180deg,#071029 0,#0b2540 100%);padding:18px;box-shadow:-10px 0 30px rgba(2,6,23,0.6);overflow:auto}
    h1{font-size:20px;margin:0 0 8px}
    .muted{color:#9fb3d6;font-size:13px}
    .country-flag{width:46px;height:32px;object-fit:cover;border-radius:4px;border:1px solid rgba(255,255,255,0.06)}
    .info-row{display:flex;gap:8px;align-items:center;margin:12px 0}
    .btn{background:#1f6feb;padding:8px 12px;border-radius:8px;color:white;cursor:pointer;border:0}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dbeafe}
    .search{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .list-item{padding:8px;border-radius:6px;margin:6px 0;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
    footer{font-size:12px;color:#9fb3d6;margin-top:10px}
    #legend{position:absolute;left:12px;bottom:12px;background:rgba(3,7,18,0.6);padding:8px;border-radius:8px;color:#cfe6ff}
  </style>
</head>
<body>
  <div id="app">
    <div id="globe-container">
      <div id="globe" style="width:100%;height:100%"></div>
      <div id="legend">Drag to rotate • Scroll to zoom • Click a country</div>
    </div>

    <aside id="sidebar">
      <h1>Interactive Travel Globe</h1>
      <div class="muted">Scroll around the globe and click any country to see travel info, famous places and more. Built with Globe.gl + public APIs.</div>

      <div style="margin-top:12px">
        <input id="search" class="search" placeholder="Search country (e.g. Japan)" />
      </div>

      <div id="country-card" style="margin-top:12px;display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:12px;align-items:center">
            <img id="flag" class="country-flag" src="" alt="flag" />
            <div>
              <div id="country-name" style="font-weight:600"></div>
              <div id="country-sub" class="muted" style="font-size:13px"></div>
            </div>
          </div>
          <div>
            <button id="visit-btn" class="btn">Mark visited</button>
            <button id="wish-btn" class="btn-ghost">Add to wishlist</button>
          </div>
        </div>

        <div id="basic-info" style="margin-top:12px">
          <div class="info-row"><div class="muted">Capital</div><div id="capital"></div></div>
          <div class="info-row"><div class="muted">Population</div><div id="population"></div></div>
          <div class="info-row"><div class="muted">Languages</div><div id="languages"></div></div>
          <div class="info-row"><div class="muted">Currency</div><div id="currency"></div></div>
        </div>

        <h3 style="margin-top:12px">Top links & places</h3>
        <div id="places"></div>

        <h3 style="margin-top:12px">Quick facts</h3>
        <div id="facts"></div>

      </div>

      <div id="placeholder" style="margin-top:20px">
        <div class="muted">No country selected — try clicking one on the globe or search above.</div>
      </div>

      <div style="margin-top:18px">
        <h4>Saved</h4>
        <div id="saved-list" class="muted">No saved countries yet.</div>
      </div>

      <footer>Built for an informatics project — you can host this as a single HTML file.</footer>
    </aside>
  </div>

  <!-- Libraries (CDN) -->
  <script src="https://unpkg.com/three@0.150.0/build/three.min.js"></script>
  <script src="https://unpkg.com/globe.gl"></script>

  <script>
  // === Basic app structure ===
  const Globe = window.Globe;
  const globeEl = document.getElementById('globe');
  const searchInput = document.getElementById('search');
  const countryCard = document.getElementById('country-card');
  const placeholder = document.getElementById('placeholder');
  const savedList = document.getElementById('saved-list');

  const countryNameEl = document.getElementById('country-name');
  const countrySubEl = document.getElementById('country-sub');
  const flagEl = document.getElementById('flag');
  const capitalEl = document.getElementById('capital');
  const populationEl = document.getElementById('population');
  const languagesEl = document.getElementById('languages');
  const currencyEl = document.getElementById('currency');
  const placesEl = document.getElementById('places');
  const factsEl = document.getElementById('facts');
  const visitBtn = document.getElementById('visit-btn');
  const wishBtn = document.getElementById('wish-btn');

  // Keep simple saved state in localStorage
  const STORAGE_KEY = 'travel-globe-saved';
  function loadSaved(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') }catch(e){return []} }
  function saveSaved(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)) }
  function updateSavedUI(){
    const items = loadSaved();
    if(items.length===0){ savedList.textContent='No saved countries yet.'; return }
    savedList.innerHTML = items.map(c => `<div class=\"list-item\">${escapeHtml(c)}</div>`).join('');
  }
  updateSavedUI();

  // Helper: basic escaping
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

  // Create globe
  const world = Globe()
    (globeEl)
    .width(() => document.getElementById('globe-container').clientWidth)
    .height(() => document.getElementById('globe-container').clientHeight)
    .backgroundColor('#071027')
    .showAtmosphere(true)
    .atmosphereColor('#3aa0ff')
    .atmosphereAltitude(0.25)
    .polygonsTransitionDuration(300)
    .onPolygonHover(p => globeEl.style.cursor = p ? 'pointer' : null)
    .onPolygonClick(feature => onCountryClick(feature.properties))
    .polygonLabel(({ properties: d }) => `
      <b>${d.name || d.ADMIN || 'Unknown'}</b>
    `);

  // fetch a GeoJSON of world countries (with names)
  fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
    .then(r => r.json())
    .then(geojson => {
      // ensure features have centroids for placing markers
      geojson.features.forEach(f => {
        f.properties.name = f.properties.name || f.properties.ADMIN || f.id || 'Unknown';
      });
      world
        .polygonsData(geojson.features)
        .polygonAltitude(0.06) // non-zero altitude so raycasting works
        .polygonCapColor(() => 'rgba(56, 189, 248, 0.65)')
        .polygonSideColor(() => 'rgba(14, 165, 233, 0.15)')
        .polygonStrokeColor(() => '#0f172a')
        .polygonResolution(3)
        .onPolygonHover(d => globeEl.style.cursor = d ? 'pointer' : 'default')
        .onPolygonClick(d => onCountryClick(d.properties));

      // optional: add small labels / points for capitals by fetching resting data later
    })
    .catch(err => console.error('Failed to load countries geojson', err));

  // Resize handling
  window.addEventListener('resize', () => {
    world.width(document.getElementById('globe-container').clientWidth)
    world.height(document.getElementById('globe-container').clientHeight)
  });

  // === Country click handler: fetch info and display in sidebar ===
  let latestCountry = null;
  async function onCountryClick(props){
    // props will include a 'name' property from the geojson source
    const name = props.name || props.ADMIN || props.NAME || props.name_long || 'Unknown';
    latestCountry = name;
    placeholder.style.display='none';
    countryCard.style.display='block';
    countryNameEl.textContent = name;
    countrySubEl.textContent = 'Loading...';
    flagEl.src = '';
    capitalEl.textContent = populationEl.textContent = languagesEl.textContent = currencyEl.textContent = '';
    placesEl.innerHTML = factsEl.innerHTML = '';

    // Fetch country details from REST Countries (by name). Use fallback if fullText fails.
    let rest = null;
    try{
      const r = await fetch('https://restcountries.com/v3.1/name/' + encodeURIComponent(name) + '?fullText=true');
      if(r.ok) rest = (await r.json())[0];
      else {
        // fallback to non-fulltext search
        const r2 = await fetch('https://restcountries.com/v3.1/name/' + encodeURIComponent(name));
        if(r2.ok) rest = (await r2.json())[0];
      }
    }catch(e){ console.warn('REST Countries failed', e) }

    if(rest){
      countrySubEl.textContent = rest.region + ' • ' + (rest.subregion || '')
      flagEl.src = rest.flags?.png || rest.flags?.svg || '';
      capitalEl.textContent = (rest.capital || ['-']).join(', ');
      populationEl.textContent = rest.population ? numberWithCommas(rest.population) : '-';
      languagesEl.textContent = rest.languages ? Object.values(rest.languages).join(', ') : '-';
      const currencies = rest.currencies ? Object.values(rest.currencies).map(c=>c.name + ' ('+c.symbol+')') : [];
      currencyEl.textContent = currencies.join(', ');

      // Provide quick facts
      const facts = [];
      if(rest.area) facts.push('Area: ' + numberWithCommas(rest.area) + ' km²');
      if(rest.capital) facts.push('Capital: ' + rest.capital.join(', '));
      if(rest.timezones) facts.push('Timezone(s): ' + rest.timezones.slice(0,3).join(', '));
      factsEl.innerHTML = facts.map(f=>`<div class=\"list-item\">${escapeHtml(f)}</div>`).join('');

    } else {
      countrySubEl.textContent = 'Details not found in REST Countries (name mismatch).'
    }

    // Fetch Wikipedia search results for tourist attractions
    try{
      const q = `tourist attractions in ${name}`;
      const wiki = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=' + encodeURIComponent(q) + '&srlimit=6&format=json&origin=*');
      const data = await wiki.json();
      if(data?.query?.search?.length){
        placesEl.innerHTML = data.query.search.map(s => `
          <a class=\"list-item\" href=\"https://en.wikipedia.org/wiki/${encodeURIComponent(s.title)}\" target=\"_blank\">${escapeHtml(s.title)} — ${escapeHtml(s.snippet.replace(/<[^>]+>/g,''))}...</a>
        `).join('');
      } else {
        placesEl.innerHTML = '<div class="muted">No quick Wikipedia hits. Try visiting a specific travel site or add your own notes.</div>';
      }
    }catch(e){ placesEl.innerHTML = '<div class="muted">Wikipedia query failed.</div>'; console.warn(e) }

    // update saved-state buttons
    const saved = loadSaved();
    visitBtn.textContent = saved.includes(name) ? 'Visited ✓' : 'Mark visited';
  }

  function numberWithCommas(x){ return x?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') }

  // Search box quick jump: center globe on first matched country feature
  searchInput.addEventListener('keydown', async (e) => {
    if(e.key !== 'Enter') return;
    const q = searchInput.value.trim(); if(!q) return;
    // try to find polygon by name
    const polys = world.polygonsData();
    const found = polys.find(p => (p.properties.name||'').toLowerCase() === q.toLowerCase());
    if(found){
      // compute centroid and animate camera
      const centroid = getFeatureCentroid(found);
      world.pointOfView({ lat: centroid[1], lng: centroid[0], altitude: 1.5 }, 1000);
      onCountryClick(found.properties);
    } else {
      // fallback: use REST Countries to get latlng
      try{
        const r = await fetch('https://restcountries.com/v3.1/name/' + encodeURIComponent(q));
        if(r.ok){
          const js = await r.json();
          const country = js[0];
          if(country?.latlng){
            world.pointOfView({ lat: country.latlng[0], lng: country.latlng[1], altitude: 1.5 }, 1500);
            onCountryClick({ name: country.name.common });
          } else alert('Found country but no coordinates');
        } else alert('Country not found');
      }catch(err){ alert('Search failed') }
    }
  });

  // Quick centroid calc (approx) from polygon coordinates
  function getFeatureCentroid(feature){
    // feature.geometry.coordinates is an array of polygons. We'll average the first polygon's coords.
    const coords = feature.geometry && feature.geometry.coordinates && feature.geometry.coordinates[0];
    if(!coords) return [0,0];
    // coords are [lng,lat], average them
    let x=0,y=0,c=0;
    for(const part of coords){
      for(const p of part){ x += p[0]; y += p[1]; c++ }
    }
    return [x/c, y/c];
  }

  // Save visited / wishlist
  visitBtn.addEventListener('click', () => {
    if(!latestCountry) return;
    const arr = loadSaved();
    if(arr.includes(latestCountry)){
      // unmark
      const next = arr.filter(x=>x!==latestCountry);
      saveSaved(next);
      visitBtn.textContent = 'Mark visited';
    } else {
      arr.push(latestCountry); saveSaved(arr); visitBtn.textContent='Visited ✓';
    }
    updateSavedUI();
  });

  wishBtn.addEventListener('click', () => {
    if(!latestCountry) return;
    alert('Wishlist feature: you can extend this to store notes or dates in localStorage.');
  });

  // initial camera
  world.pointOfView({ lat: 20, lng: 0, altitude: 2.2 });

  </script>
</body>
</html>
